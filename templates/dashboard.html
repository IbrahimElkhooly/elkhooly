{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <h2 class="text-center mb-4">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ØªØ­Ù„ÙŠÙ„ÙŠØ©</h2>

    <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="students-tab" data-bs-toggle="tab" href="#students" role="tab">ğŸ‘¨â€ğŸ“ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ø§Ù„Ù…ÙˆØ§Ø¯</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="exams-tab" data-bs-toggle="tab" href="#exams" role="tab">ğŸ“Š Ù…ØªÙˆØ³Ø· Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="homeworks-tab" data-bs-toggle="tab" href="#homeworks" role="tab">ğŸ“‹ ØªØ³Ù„ÙŠÙ…Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="codes-tab" data-bs-toggle="tab" href="#codes" role="tab">ğŸ”‘ Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</a>
        </li>
    </ul>

    <div class="tab-content p-3 border border-top-0">

        <!-- Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ø§Ù„Ù…ÙˆØ§Ø¯ -->
        <div class="tab-pane fade show active" id="students" role="tabpanel">
            <h4>ğŸ‘¨â€ğŸ“ Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ ÙƒÙ„ Ù…Ø§Ø¯Ø©</h4>

            <input type="text" id="filterStudents" class="form-control mb-2" placeholder="ÙÙ„ØªØ± Ø­Ø³Ø¨ Ø§Ù„Ù…Ø§Ø¯Ø©">

            <canvas id="studentsChart"></canvas>
            <table class="table table-bordered table-striped mt-3" id="studentsTable">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                        <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in students_per_subject %}
                    <tr>
                        <td>{{ row.subject_name }}</td>
                        <td>{{ row.student_count }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Ù…ØªÙˆØ³Ø· Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª -->
        <div class="tab-pane fade" id="exams" role="tabpanel">
            <h4>ğŸ“Š Ù…ØªÙˆØ³Ø· Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª</h4>

            <input type="text" id="filterExams" class="form-control mb-2" placeholder="ÙÙ„ØªØ± Ø­Ø³Ø¨ Ø§Ù„Ù…Ø§Ø¯Ø©">

            <canvas id="examsChart"></canvas>
            <table class="table table-bordered table-striped mt-3" id="examsTable">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                        <th>Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in avg_scores_per_subject %}
                    <tr>
                        <td>{{ row.subject_name }}</td>
                        <td>{{ row.avg_score|round(2) }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- ØªØ³Ù„ÙŠÙ…Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª -->
        <div class="tab-pane fade" id="homeworks" role="tabpanel">
            <h4>ğŸ“‹ Ø­Ø§Ù„Ø© ØªØ³Ù„ÙŠÙ…Ø§Øª Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª</h4>

            <input type="text" id="filterHomeworks" class="form-control mb-2" placeholder="ÙÙ„ØªØ± Ø­Ø³Ø¨ Ø§Ù„Ù…Ø§Ø¯Ø©">

            <canvas id="homeworksChart"></canvas>
            <table class="table table-bordered table-striped mt-3" id="homeworksTable">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                        <th>Ø§Ù„ÙˆØ§Ø¬Ø¨</th>
                        <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</th>
                        <th>ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</th>
                        <th>Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</th>
                    </tr>
                </thead>
                <tbody>
                    {% for hw in homework_submissions %}
                    <tr>
                        <td>{{ hw.subject_name }}</td>
                        <td>{{ hw.title }}</td>
                        <td>{{ hw.total_students }}</td>
                        <td>{{ hw.submitted_students }}</td>
                        <td>{{ hw.not_submitted }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ -->
        <div class="tab-pane fade" id="codes" role="tabpanel">
            <h4>ğŸ”‘ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</h4>

            <input type="text" id="filterCodes" class="form-control mb-2" placeholder="ÙÙ„ØªØ± Ø­Ø³Ø¨ Ø§Ù„Ù…Ø§Ø¯Ø©">

            <canvas id="codesChart"></canvas>
            <table class="table table-bordered table-striped mt-3" id="codesTable">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                        <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</th>
                        <th>Ø£ÙƒÙˆØ§Ø¯ Ù…Ø³ØªØ®Ø¯Ù…Ø©</th>
                        <th>Ø£ÙƒÙˆØ§Ø¯ ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…Ø©</th>
                    </tr>
                </thead>
                <tbody>
                    {% for code in codes_usage %}
                    <tr>
                        <td>{{ code.subject_name }}</td>
                        <td>{{ code.total_codes }}</td>
                        <td>{{ code.used_codes }}</td>
                        <td>{{ code.unused_codes }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const filterTable = (inputId, tableId) => {
        const filter = document.getElementById(inputId).value.toLowerCase();
        const rows = document.querySelectorAll(`#${tableId} tbody tr`);
        rows.forEach(row => {
            const subject = row.cells[0].textContent.toLowerCase();
            row.style.display = subject.includes(filter) ? '' : 'none';
        });
    };

    ['filterStudents', 'filterExams', 'filterHomeworks', 'filterCodes'].forEach((filterId, index) => {
        const tableIds = ['studentsTable', 'examsTable', 'homeworksTable', 'codesTable'];
        document.getElementById(filterId).addEventListener('input', () => filterTable(filterId, tableIds[index]));
    });

    new Chart(document.getElementById('studentsChart'), {
        type: 'bar',
        data: {
            labels: {{ students_per_subject|map(attribute='subject_name')|list|tojson }},
            datasets: [{ label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨', data: {{ students_per_subject|map(attribute='student_count')|list|tojson }}, backgroundColor: '#007bff' }]
        }
    });

    new Chart(document.getElementById('examsChart'), {
        type: 'bar',
        data: {
            labels: {{ avg_scores_per_subject|map(attribute='subject_name')|list|tojson }},
            datasets: [{ label: 'Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª', data: {{ avg_scores_per_subject|map(attribute='avg_score')|list|tojson }}, backgroundColor: '#28a745' }]
        }
    });

    new Chart(document.getElementById('homeworksChart'), {
        type: 'bar',
        data: {
            labels: {{ homework_submissions|map(attribute='title')|list|tojson }},
            datasets: [
                { label: 'ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…', data: {{ homework_submissions|map(attribute='submitted_students')|list|tojson }}, backgroundColor: '#ffc107' },
                { label: 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…', data: {{ homework_submissions|map(attribute='not_submitted')|list|tojson }}, backgroundColor: '#dc3545' }
            ]
        }
    });

    new Chart(document.getElementById('codesChart'), {
        type: 'bar',
        data: {
            labels: {{ codes_usage|map(attribute='subject_name')|list|tojson }},
            datasets: [
                { label: 'Ø£ÙƒÙˆØ§Ø¯ Ù…Ø³ØªØ®Ø¯Ù…Ø©', data: {{ codes_usage|map(attribute='used_codes')|list|tojson }}, backgroundColor: '#6f42c1' },
                { label: 'Ø£ÙƒÙˆØ§Ø¯ ØºÙŠØ± Ù…Ø³ØªØ®Ø¯Ù…Ø©', data: {{ codes_usage|map(attribute='unused_codes')|list|tojson }}, backgroundColor: '#adb5bd' }
            ]
        }
    });
</script>
{% endblock %}
