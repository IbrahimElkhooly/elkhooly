{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h2 style="text-align: center; margin-top: 20px;">{{ exam_name }}</h2>

    <!-- ✅ عداد تنازلي -->
    <div id="timer-box" class="alert alert-warning text-center fw-bold" style="font-size: 20px;">
        <i class="fas fa-hourglass-half"></i> الوقت المتبقي: <span id="countdown"></span>
    </div>

    <form id="exam-form" method="POST">
        <input type="hidden" id="start_time" name="start_time" value="">
        {% for question in questions %}
            <div class="question">
                <p><strong>السؤال:</strong> {{ question.question_text }}</p>
                {% if question.question_type == 'mcq' %}
                    <p><strong>الاختيارات:</strong></p>
                    <ul>
                        {% for choice in question.choices %}
                            <li>
                                <input type="radio" name="q{{ question.id }}" value="{{ choice.choice_text }}" required>
                                {{ choice.choice_text }}
                            </li>
                        {% endfor %}
                    </ul>
                {% elif question.question_type == 'true_false' %}
                    <p><strong>الإجابة:</strong></p>
                    <input type="radio" name="q{{ question.id }}" value="صح" required> صح
                    <input type="radio" name="q{{ question.id }}" value="خطأ" required> خطأ
                {% elif question.question_type == 'short_answer' %}
                    <p><strong>الإجابة:</strong></p>
                    <input type="text" name="q{{ question.id }}" placeholder="أدخل إجابتك هنا" required>
                {% endif %}
            </div>
            <hr>
        {% endfor %}

        <button type="submit" class="btn btn-primary" id="submit-btn">إرسال الإجابات</button>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const startTimeField = document.getElementById('start_time');
    startTimeField.value = new Date().toISOString();
});

let duration = {{ exam_duration }} * 60;  // المدة بالثواني
let countdownElement = document.getElementById("countdown");
let form = document.getElementById("exam-form");
let submitButton = document.getElementById("submit-btn");
let timer;

function submitExam() {
    if (!confirm("هل أنت متأكد من تسليم الامتحان؟")) return;

    let formData = new FormData(form);

    fetch("{{ url_for('submit_exam', exam_id=exam_id) }}", {
        method: "POST",
        body: formData
    }).then(response => response.json())
      .then(data => {
          if (data.success) {
              alert("تم حفظ الإجابات بنجاح!");
              window.location.href = data.redirect_url;
          } else {
              alert("حدث خطأ أثناء حفظ الإجابات: " + data.message);
          }
      }).catch(error => console.error("Error:", error));
}

function startCountdown() {
    function updateCountdown() {
        let minutes = Math.floor(duration / 60);
        let seconds = duration % 60;
        countdownElement.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;

        if (duration <= 0) {
            clearInterval(timer);
            alert("انتهى وقت الامتحان، يتم تسليم الإجابات الآن!");
            submitButton.disabled = true;  // ✅ تعطيل الزر بعد انتهاء الوقت
            submitExam();
        }

        duration--;
    }

    updateCountdown();
    timer = setInterval(updateCountdown, 1000);
}

form.addEventListener("submit", function(event) {
    event.preventDefault();
    submitExam();
});

window.onload = startCountdown;
</script>

{% endblock %}
